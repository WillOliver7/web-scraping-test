<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/@rails/actioncable@7.0.0/app/assets/javascripts/action_cable.js"></script>
    <title>Manager Scraping</title>
    <style>
      body {
        font-family: sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      header {
        background: #1877f2;
        color: white;
        padding: 15px;
        width: 100%;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .user-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 15px;
        padding: 0 20px;
      }
      .container {
        display: flex;
        justify-content: space-between;
        width: 95%;
        margin-top: 20px;
        gap: 20px;
      }
      .left-panel, .right-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .left-panel { width: 35%; }
      .right-panel { width: 60%; }
      
      input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
      }
      button {
        padding: 10px 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 10px;
      }
      .btn-primary {
        background: #42b72a;
        color: white;
      }
      .btn-nav {
        background: #e4e6eb;
        color: #050505;
        font-size: 12px;
        margin: 0 5px;
        padding: 5px 10px;
      }
      .btn-nav:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        font-size: 13px;
        margin-top: 15px;
      }
      th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }
      th {
        background: #f8f9fa;
        color: #666;
      }
      .hide { display: none; }
      .progress-container {
        width: 100%;
        background-color: #e0e0e0;
        border-radius: 10px;
        margin-top: 8px;
        height: 10px;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        background-color: #1877f2;
        width: 0%;
        transition: width 0.4s ease-in-out;
      }
      .pagination-ctrl {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 6px;
      }
      .page-info {
        font-size: 12px;
        font-weight: bold;
        color: #65676b;
      }
    </style>
  </head>
  <body>

  <header>
    <div class="user-header hide" id="user-header">
      <strong id="display-email"></strong>
      <button class="btn-logout" onclick="logout()">Sair</button>
    </div>
  </header>

  <div id="auth-box" class="hide">
    <h2>Login / Cadastro</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Senha">
    <button class="btn-primary" onclick="auth('login')">Entrar</button>
    <button class="btn-primary" onclick="auth('signup')">Criar Conta</button>
  </div>

  <div class="container hide" id="dashboard-container">
    <div class="left-panel">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h4>Nova Extração</h4>
        <div class="pagination-ctrl">
          <button class="btn-nav" id="task-prev" onclick="changeTaskPage(-1)">◀</button>
          <span class="page-info" id="task-page-info">Página 1</span>
          <button class="btn-nav" id="task-next" onclick="changeTaskPage(1)">▶</button>
        </div>
      </div>
      <input type="text" id="url" placeholder="Cole a URL para scraping...">
      <button class="btn-primary" onclick="startScraping()">Iniciar Extração</button>
      
      <h4>Status das Tasks</h4>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Status</th>
            <th>Progresso</th>
          </tr>
        </thead>
        <tbody id="notifications-table-body"></tbody>
      </table>
      
    </div>

    <div class="right-panel">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h4>Banco de Citações</h4>
        <div class="pagination-ctrl">
          <button class="btn-nav" id="quote-prev" onclick="changeQuotePage(-1)">◀</button>
          <span class="page-info" id="quote-page-info">Página 1</span>
          <button class="btn-nav" id="quote-next" onclick="changeQuotePage(1)">▶</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID Quote</th>
            <th>Autor</th>
            <th>Citação</th>
            <th>Task Ref</th>
          </tr>
        </thead>
        <tbody id="quotes-table-body"></tbody>
      </table>

    </div>
  </div>

  <script>
    const AUTH_URL = "http://localhost:3001";
    const cable = ActionCable.createConsumer("ws://localhost:3002/cable");
    const activeSubscriptions = {};
    
    // Estados de Paginação
    let currentTaskPage = 1;
    let currentQuotePage = 1;
    let totalTaskPages = 1;
    let totalQuotePages = 1;

    window.onload = () => {
      if (localStorage.getItem('token')) {
        showUser();
        loadTasks();
        loadQuotes();
      } else {
        document.getElementById('auth-box').classList.remove('hide');
      }
    };

    // --- AUTH & LOGOUT ---
    async function auth(type) {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const path = type === 'login' ? '/login' : '/signup';
      try {
        const resp = await fetch(`${AUTH_URL}${path}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, password_confirmation: password })
        });
        const data = await resp.json();
        if (resp.ok) {
          if (type === 'login') {
            localStorage.setItem('token', data.token);
            localStorage.setItem('email', data.email);
            showUser();
            loadTasks();
            loadQuotes();
          } else { alert("Conta criada!"); }
        } else { alert("Erro: " + JSON.stringify(data)); }
      } catch (e) { alert("Erro de conexão"); }
    }

    function showUser() {
      document.getElementById('auth-box').classList.add('hide');
      document.getElementById('dashboard-container').classList.remove('hide');
      document.getElementById('user-header').classList.remove('hide');
      document.getElementById('display-email').innerText = localStorage.getItem('email');
    }

    function logout() {
      localStorage.clear();
      location.reload();
    }

    // --- SCRAPING ---
    async function startScraping() {
      const url = document.getElementById('url').value;
      if (!url) return alert("Insira uma URL!");
      try {
        const resp = await fetch('/tasks', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ task: { url: url } })
        });
        if (resp.ok) {
          document.getElementById('url').value = "";
          currentTaskPage = 1; // Volta para a primeira página para ver a nova task
          loadTasks();
        }
      } catch (e) { console.error(e); }
    }

    // --- CARREGAMENTO DE TASKS (KAMINARI) ---
    async function loadTasks() {
      try {
        const resp = await fetch(`/tasks?page=${currentTaskPage}`, {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const result = await resp.json(); // Espera { data: [], meta: {} }
        totalTaskPages = result.meta.total_pages;
        renderProcessing(result.data);
        updatePaginationUI('task', result.meta);
      } catch (e) { console.error(e); }
    }

    function changeTaskPage(step) {
      const target = currentTaskPage + step;
      if (target >= 1 && target <= totalTaskPages) {
        currentTaskPage = target;
        loadTasks();
      }
    }

    // --- CARREGAMENTO DE QUOTES (KAMINARI) ---
    async function loadQuotes() {
      const quotesBody = document.getElementById('quotes-table-body');
      quotesBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Atualizando...</td></tr>';
      try {
        const resp = await fetch(`/quotes?page=${currentQuotePage}`, {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const result = await resp.json();
        totalQuotePages = result.meta.total_pages;
        renderQuotes(result.data);
        updatePaginationUI('quote', result.meta);
      } catch (e) { console.error(e); }
    }

    function changeQuotePage(step) {
      const target = currentQuotePage + step;
      if (target >= 1 && target <= totalQuotePages) {
        currentQuotePage = target;
        loadQuotes();
      }
    }

    // --- RENDERIZAÇÃO E UI ---
    function updatePaginationUI(prefix, meta) {
      document.getElementById(`${prefix}-page-info`).innerText = `Página ${meta.current_page} de ${meta.total_pages}`;
      document.getElementById(`${prefix}-prev`).disabled = !meta.prev_page;
      document.getElementById(`${prefix}-next`).disabled = !meta.next_page;
    }

    function renderQuotes(quotes) {
      const body = document.getElementById('quotes-table-body');
      if (!quotes || quotes.length === 0) {
        body.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhuma citação.</td></tr>';
        return;
      }
      body.innerHTML = quotes.map(q => `
        <tr>
          <td><strong>#${q.id}</strong></td>
          <td>${q.author}</td>
          <td style="font-style: italic; color: #444;">"${q.content}"</td>
          <td style="color: #999;">Task #${q.task_id}</td>
        </tr>
      `).join('');
    }

    function renderProcessing(tasks) {
      const body = document.getElementById('notifications-table-body');
      if (!tasks || tasks.length === 0) {
        body.innerHTML = '<tr><td colspan="3" style="text-align:center;">Nenhuma task.</td></tr>';
        return;
      }
      body.innerHTML = tasks.map(task => {
        if (task.status === 'processing' || task.status === 'pending') {
          setupSubscription(task.id);
        }
        return `
          <tr id="task-row-${task.id}">
            <td><strong>#${task.id}</strong></td>
            <td>
              <span id="status-badge-${task.id}" style="padding: 2px 6px; border-radius: 4px; font-size: 11px; background: ${statusColor(task.status)}">
                ${task.status.toUpperCase()}
              </span>
            </td>
            <td width="50%">
              <div class="progress-container">
                <div class="progress-bar" id="progress-bar-${task.id}" style="width: ${task.status === 'completed' ? '100%' : '5%'}"></div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // --- WEBSOCKETS ---
    function setupSubscription(taskId) {
      if (activeSubscriptions[taskId]) return;
      activeSubscriptions[taskId] = cable.subscriptions.create(
        { channel: "ProgressChannel", task_id: taskId },
        {
          received(data) {
            const bar = document.getElementById(`progress-bar-${taskId}`);
            const badge = document.getElementById(`status-badge-${taskId}`);
            if (bar) bar.style.width = data.percentage + "%";
            if (badge) {
              badge.innerText = data.status.toUpperCase();
              badge.style.background = statusColor(data.status);
            }
            if (data.status === 'completed') {
              // Se estiver na primeira página, atualiza quotes automaticamente
              if (currentQuotePage === 1) loadQuotes();
              setTimeout(() => { loadTasks(); }, 2000);
            }
          }
        }
      );
    }

    function statusColor(status) {
      switch(status) {
        case 'completed': return '#dfd';
        case 'processing': return '#fff3cd';
        case 'failed': return '#f8d7da';
        default: return '#eee';
      }
    }
  </script>
  </body>
</html>